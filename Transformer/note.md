# 编码问题
# 什么是位置编码

​		在时序任务中，特征与特征间是有顺序关系的，比如NLP中的词与词之间顺序不一致，意思也不一样。
​		在模型中不仅仅需要考虑特征的表征，还需要考虑位置信息，也就是位置编码。
​		在RNN\LSTM此类模型中，由于输入即是有序的，所以位置信息实际上是被隐式嵌入了。
​		在Transformer模型中，token经过embeddeding后是没有位置信息的，是一个对称模型。所以需要使用一个专门的position embedding将位置信息嵌入模型中。



位置信息嵌入需要解决以下几个问题：

1. 能够表示一个token在sentence中的绝对位置；
2. 在序列长度不同的时候，不同序列中的相对距离也应保持一致。
3. 外推。可以用来表示模型在训练时从未见过的句子长度。
4. 值有界。

​		对于第一个问题，可以采用索引法，例如直接以0，1，2，...，n进行编码，但是索引无界，且索引越大数值越大，容易掩盖掉token embeddeding本身的向量，难以收敛。
​		所以可以采用相对索引，将索引归一到[0,1]之间，避免索引数值过大，但是带来了一个相对距离的问题，相邻两个token之间的position embedding 在不同的sentences中相对距离不一致。



为解决上述问题，常用的包括：绝对位置编码，相对位置编码。

# 绝对位置编码
绝对位置编码只依靠token的绝对位置来进行编码，一般来说以：Ei+Pi为形式，即token的embedding+token的绝对位置编码Pi
常见的绝对位置编码包括：1、Sinusoidal三角函数编码；2、RoPE螺旋编码(主流大模型常用)

### Sinusoidal

​    P(k,2i)=sin(k/(10000\*\*(2i/d_model))
​    P(k,2i+1)=cos(k/(10000\*\*(2i+1/d_model))
​    其中k是token的绝对位置，i是该token的embedding向量的索引。
​    即一个sentences表示为[512,1024]，其中512是2k的取值范围，1024是i的取值范围。



### RoPE

​		RoPE是绝对位置编码，但是依靠绝对编码的形式嵌入了相对位置信息，主要思想是通过q,k矩阵内积，将相对信息位置嵌入。

#### 结论

​		编码形式：[x,y] = [x\*cosnθ-y\*sinnθ,x\*sinnθ+y\*cosnθ]

#### 证明

​        假设某个位置m的q的向量为二维向量qm=[xm,ym]，k在n的向量为kn=[xn,yn]
​        假设函数f(qm,m)代表为q嵌入相应位置信息，同理有f(kn,n)
​        目标：<f(qm,m),f(kn,n)> == R(qm,qn,m-n)，即融入位置信息后的qm和kn，在计算内积之后与m-n相关。

​        过程：
​            对于两个二维向量qm,kn，其内积为<qm,qn>，若对于向量qm=[xm,yn]，将x,y表述成复数形式，即x+yi。
​            同理kn也可以表述成复数形式，则有如下等式：
​            <qm,kn>=Re[qm\*kn<sup>*</sup>]

​			其中kn<sup>*</sup>表示kn的共轭复数，Re表示取实部，证明公式略过。



​		 此时，还没有嵌入位置编码，接下来进行嵌入:
​            	qm=qm\*e<sup>imθ</sup>]，kn同理，那么有<qm,qn>=Re[qm\*kn\*×e<sup>i(m-n)θ</sup>]
​            	则可得加入位置编码后的<**f**(qm,m),**f**(kn,n)> == **R**(qm,qn,m-n)
​            	此时，利用绝对位置编码的形式，嵌入了相对信息。*

​				矩阵表示：
​    					对于qm\*e<sup>imθ</sup>=(x+yi)\*e<sup>imθ</sup>

   							e<sup>iθ</sup>=cosθ+isinθ

   				 	则(x+yi)\*e<sup>imθ</sup>=(x+yi)\*(cosθ+isinθ)=(xcosθ-ysinθ)+i(xsinθ+ysinθ)
       			 	转回矩阵表示：
           				 	[x,y] = [x\*cosnθ-y\*sinnθ,x\*sinnθ+y\*cosnθ]

​		推广：
​        		内积满足线性叠加性，因此任意偶数维的RoPE，我们都可以表示为二维情形的拼接，则
​       		 f(q)=[q0,q1,q2,q3,....,qd-2,qd-1]\*[cosmθ0,cosmθ0,....,cosmθd/2-1,cosmθd/2]+
​            			[-q1,q0,-q3,q2,....,-qd-1,qd-2]\*[sinmθ0,sinmθ0,....,sinmθd/2-1,sinmθd/2]
​        		

​				在实际中q矩阵由于是wx求的得，所以可以去除-号。